var self="undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};self.URL=self.URL||self.webkitURL;self.requestFileSystem=self.requestFileSystem||self.webkitRequestFileSystem;self.resolveLocalFileSystemURL=self.resolveLocalFileSystemURL||self.webkitResolveLocalFileSystemURL;navigator.temporaryStorage=navigator.temporaryStorage||navigator.webkitTemporaryStorage;navigator.persistentStorage=navigator.persistentStorage||navigator.webkitPersistentStorage;
self.BlobBuilder=self.BlobBuilder||self.MozBlobBuilder||self.WebKitBlobBuilder;if(void 0===self.FileError)self.FileError=function(){},self.FileError.prototype.prototype=Error.prototype;
var Util={toArray:function(a){return Array.prototype.slice.call(a||[],0)},strToDataURL:function(a,b,c){return(void 0!=c?c:1)?"data:"+b+";base64,"+self.btoa(a):"data:"+b+","+a},strToObjectURL:function(a,b){for(var c=new Uint8Array(a.length),e=0;e<c.length;++e)c[e]=a.charCodeAt(e);c=new Blob([c],b?{type:b}:{});return self.URL.createObjectURL(c)},fileToObjectURL:function(a){return self.URL.createObjectURL(a)},fileToArrayBuffer:function(a,b,c){var e=new FileReader;e.onload=function(a){b(a.target.result)};
e.onerror=function(a){c&&c(a)};e.readAsArrayBuffer(a)},dataURLToBlob:function(a){if(-1==a.indexOf(";base64,")){var b=a.split(","),a=b[0].split(":")[1],b=decodeURIComponent(b[1]);return new Blob([b],{type:a})}for(var b=a.split(";base64,"),a=b[0].split(":")[1],b=window.atob(b[1]),c=b.length,e=new Uint8Array(c),h=0;h<c;++h)e[h]=b.charCodeAt(h);return new Blob([e],{type:a})},arrayBufferToBlob:function(a,b){var c=new Uint8Array(a);return new Blob([c],b?{type:b}:{})},arrayBufferToBinaryString:function(a,
b,c){var e=new FileReader;e.onload=function(a){b(a.target.result)};e.onerror=function(a){c&&c(a)};a=new Uint8Array(a);e.readAsBinaryString(new Blob([a]))},arrayToBinaryString:function(a){if("object"!=typeof a)return null;for(var b=a.length,c=Array(b);b--;)c[b]=String.fromCharCode(a[b]);return c.join("")},getFileExtension:function(a){var b=a.lastIndexOf(".");return-1!=b?a.substring(b):""}},MyFileError=function(a){this.prototype=self.FileError.prototype;this.code=a.code;this.name=a.name};
self.FileError.BROWSER_NOT_SUPPORTED=1E3;self.FileError.prototype.__defineGetter__("name",function(){for(var a=Object.keys(self.FileError),b=0,c;c=a[b];++b)if(self.FileError[c]==this.code)return c;return"Unknown Error"});
var Filer=new function(){function a(d){if(b=d||null)c=b.root,e=!0}var b=null,c=null,e=!1,h=function(d){return 0==d.indexOf("filesystem:")},l=function(d){h(d)||(d="/"==d[0]?b.root.toURL()+d.substring(1):0==d.indexOf("./")||0==d.indexOf("../")?"../"==d&&c!=b.root?c.toURL()+"/"+d:c.toURL()+d:c.toURL()+"/"+d);return d},k=function(d,a){var b=arguments[1],c=arguments[2],g=function(d){if(d.code==self.FileError.NOT_FOUND_ERR){if(c)throw Error('"'+b+'" or "'+c+'" does not exist.');throw Error('"'+b+'" does not exist.');
}throw Error("Problem getting Entry for one or more paths.");},j=l(b);if(3==arguments.length){var i=l(c);self.resolveLocalFileSystemURL(j,function(a){self.resolveLocalFileSystemURL(i,function(b){d(a,b)},g)},g)}else self.resolveLocalFileSystemURL(j,d,g)},n=function(d,a,c,f,g,j){if(!b)throw Error("Filesystem has not been initialized.");if(typeof d!=typeof a)throw Error("These method arguments are not supported.");var i=c||null,e=void 0!=j?j:!1;(d.isFile||a.isDirectory)&&a.isDirectory?e?d.moveTo(a,i,
f,g):d.copyTo(a,i,f,g):k(function(a,d){if(d.isDirectory)e?a.moveTo(d,i,f,g):a.copyTo(d,i,f,g);else{var b=Error('Oops! "'+d.name+" is not a directory!");if(g)g(b);else throw b;}},d,a)};a.DEFAULT_FS_SIZE=1048576;a.version="0.4.3";a.prototype={get fs(){return b},get isOpen(){return e},get cwd(){return c}};a.prototype.pathToFilesystemURL=function(d){return l(d)};a.prototype.init=function(d){if(!self.requestFileSystem)throw new MyFileError({code:self.FileError.BROWSER_NOT_SUPPORTED,name:"BROWSER_NOT_SUPPORTED"});
return new Promise(function(a,m){var f=d?d:{},g=f.size||1048576;this.type=self.TEMPORARY;if("persistent"in f&&f.persistent)this.type=self.PERSISTENT;var j=function(d){this.size=g;b=d;c=b.root;e=!0;a(d)};this.type==self.PERSISTENT&&navigator.persistentStorage?navigator.persistentStorage.requestQuota(g,function(d){self.requestFileSystem(this.type,d,j.bind(this),m)}.bind(this),m):self.requestFileSystem(this.type,g,j.bind(this),m)}.bind(this))};a.prototype.ls=function(d){if(!b)throw Error("Filesystem has not been initialized.");
return new Promise(function(a,b){var f=function(d){c=d;var f=[],e=c.createReader(),h=function(){e.readEntries(function(d){d.length?(f=f.concat(Util.toArray(d)),h()):(f.sort(function(d,a){return d.name<a.name?-1:a.name<d.name?1:0}),a(f))},b)};h()};d.isDirectory?f(d):h(d)?k(f,d):c.getDirectory(d,{},f,b)}.bind(this))};a.prototype.mkdir=function(d,a){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,f){var g=null!=a?a:!1,e=d.split("/"),i=function(a,c){if("."==c[0]||
""==c[0])c=c.slice(1);a.getDirectory(c[0],{create:!0,exclusive:g},function(a){a.isDirectory?c.length&&1!=e.length?i(a,c.slice(1)):b(a):f(Error(d+" is not a directory"))},function(a){if(a.code==self.FileError.INVALID_MODIFICATION_ERR)a.message="'"+d+"' already exists",f(a)})};i(c,e)}.bind(this))};a.prototype.open=function(a){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,c){a.isFile?a.file(b,c):k(function(a){a.file(b,c)},l(a))}.bind(this))};a.prototype.create=
function(a,e){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,f){c.getFile(a,{create:!0,exclusive:null!=e?e:!0},b,function(b){if(b.code==self.FileError.INVALID_MODIFICATION_ERR)b.message="'"+a+"' already exists";f(b)})}.bind(this))};a.prototype.mv=function(a,b,c){return new Promise(function(f,g){n.bind(this,a,b,c,f,g,!0)()}.bind(this))};a.prototype.rm=function(a){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,c){var f=
function(a){a.isFile?a.remove(b,c):a.isDirectory&&a.removeRecursively(b,c)};a.isFile||a.isDirectory?f(a):k(f,a)}.bind(this))};a.prototype.cd=function(a){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,e){a.isDirectory?(c=a,b(c)):(a=l(a),k(function(a){a.isDirectory?(c=a,b(c)):e(Error("Path was not a directory."))},a))}.bind(this))};a.prototype.cp=function(a,b,c){return new Promise(function(f,e){n.bind(this,a,b,c,f,e)()}.bind(this))};a.prototype.write=function(a,
e){if(!b)throw Error("Filesystem has not been initialized.");return new Promise(function(b,f){var g=function(a){a.createWriter(function(c){c.onerror=f;if(e.append)c.onwriteend=function(){b([a,this])},c.seek(c.length);else{var d=!1;c.onwriteend=function(){d?b([a,this]):(d=!0,this.truncate(this.position))}}if(e.data.__proto__==ArrayBuffer.prototype)e.data=new Uint8Array(e.data);var g=new Blob([e.data],e.type?{type:e.type}:{});c.write(g)},f)};a.isFile?g(a):h(a)?k(g,a):c.getFile(a,{create:!0,exclusive:!1},
g,f)}.bind(this))};a.prototype.df=function(){if(!navigator.temporaryStorage.queryUsageAndQuota||!navigator.persistentStorage.queryUsageAndQuota)throw Error("Not implemented.");return new Promise(function(a,b){var c=function(b,c){a([b,c-b,c])};self.TEMPORARY==this.type?navigator.temporaryStorage.queryUsageAndQuota(c,b):self.PERSISTENT==this.type&&navigator.persistentStorage.queryUsageAndQuota(c,b)}.bind(this))};return a};module.exports=Filer;
